{"version":3,"sources":["../../../src/viewports/globe-viewport.js"],"names":["Matrix4","Viewport","PROJECTION_MODE","vec3","vec4","DEGREES_TO_RADIANS","Math","PI","RADIANS_TO_DEGREES","EARTH_RADIUS","GLOBE_RADIUS","getDistanceScales","unitsPerMeter","unitsPerDegree","unitsPerMeter2","metersPerUnit","unitsPerDegree2","degreesPerUnit","GlobeViewport","opts","latitude","longitude","zoom","nearZMultiplier","farZMultiplier","resolution","width","height","altitude","max","viewMatrix","lookAt","eye","up","scale","pow","rotateX","rotateZ","halfFov","atan","relativeScale","viewportOpts","Object","assign","fovyRadians","aspect","focalDistance","near","far","min","distanceScales","xyz","topLeft","targetZ","x","y","z","y2","pixelUnprojectionMatrix","coord","Number","isFinite","transformVector","coord0","coord1","lt","lSqr","sqrLen","sub","l0Sqr","l1Sqr","sSqr","dSqr","r0","sqrt","dr","t","lerp","unprojectPosition","X","Y","Z","lng","lat","lambda","phi","cosPhi","cos","D","sin","len","asin","atan2","lngLat","pos","fromPosition","unproject","GLOBE","matrix","vector","result","transformMat4"],"mappings":"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","sourcesContent":["import {Matrix4} from 'math.gl';\nimport Viewport from './viewport';\nimport {PROJECTION_MODE} from '../lib/constants';\n\nimport * as vec3 from 'gl-matrix/vec3';\nimport * as vec4 from 'gl-matrix/vec4';\n\nconst DEGREES_TO_RADIANS = Math.PI / 180;\nconst RADIANS_TO_DEGREES = 180 / Math.PI;\nconst EARTH_RADIUS = 6370972;\nconst GLOBE_RADIUS = 256;\n\nfunction getDistanceScales() {\n  const unitsPerMeter = GLOBE_RADIUS / EARTH_RADIUS;\n  const unitsPerDegree = (Math.PI / 180) * GLOBE_RADIUS;\n\n  return {\n    unitsPerMeter: [unitsPerMeter, unitsPerMeter, unitsPerMeter],\n    unitsPerMeter2: [0, 0, 0],\n    metersPerUnit: [1 / unitsPerMeter, 1 / unitsPerMeter, 1 / unitsPerMeter],\n    unitsPerDegree: [unitsPerDegree, unitsPerDegree, unitsPerMeter],\n    unitsPerDegree2: [0, 0, 0],\n    degreesPerUnit: [1 / unitsPerDegree, 1 / unitsPerDegree, 1 / unitsPerMeter]\n  };\n}\n\nexport default class GlobeViewport extends Viewport {\n  constructor(opts = {}) {\n    const {\n      latitude = 0,\n      longitude = 0,\n      zoom = 11,\n      nearZMultiplier = 0.1,\n      farZMultiplier = 1,\n      resolution = 10\n    } = opts;\n\n    let {width, height, altitude = 1.5} = opts;\n\n    width = width || 1;\n    height = height || 1;\n    altitude = Math.max(0.75, altitude);\n\n    // Calculate view matrix\n    const viewMatrix = new Matrix4().lookAt({eye: [0, -altitude, 0], up: [0, 0, 1]});\n    const scale = Math.pow(2, zoom);\n    viewMatrix.rotateX(latitude * DEGREES_TO_RADIANS);\n    viewMatrix.rotateZ(-longitude * DEGREES_TO_RADIANS);\n    viewMatrix.scale(scale / height);\n\n    const halfFov = Math.atan(0.5 / altitude);\n    const relativeScale = (GLOBE_RADIUS * 2 * scale) / height;\n\n    const viewportOpts = Object.assign({}, opts, {\n      // x, y,\n      width,\n      height,\n\n      // view matrix\n      viewMatrix,\n      longitude,\n      latitude,\n      zoom,\n\n      // projection matrix parameters\n      fovyRadians: halfFov * 2,\n      aspect: width / height,\n      focalDistance: altitude,\n      near: nearZMultiplier,\n      far: Math.min(2, 1 / relativeScale + 1) * altitude * farZMultiplier\n    });\n\n    super(viewportOpts);\n\n    this.resolution = resolution;\n    this.distanceScales = getDistanceScales();\n  }\n\n  get projectionMode() {\n    return PROJECTION_MODE.GLOBE;\n  }\n\n  getDistanceScales() {\n    return this.distanceScales;\n  }\n\n  unproject(xyz, {topLeft = true, targetZ} = {}) {\n    const [x, y, z] = xyz;\n\n    const y2 = topLeft ? y : this.height - y;\n    const {pixelUnprojectionMatrix} = this;\n\n    let coord;\n    if (Number.isFinite(z)) {\n      // Has depth component\n      coord = transformVector(pixelUnprojectionMatrix, [x, y2, z, 1]);\n    } else {\n      // since we don't know the correct projected z value for the point,\n      // unproject two points to get a line and then find the point on that line that intersects with the sphere\n      const coord0 = transformVector(pixelUnprojectionMatrix, [x, y2, -1, 1]);\n      const coord1 = transformVector(pixelUnprojectionMatrix, [x, y2, 1, 1]);\n\n      const lt = ((targetZ || 0) / EARTH_RADIUS + 1) * GLOBE_RADIUS;\n      const lSqr = vec3.sqrLen(vec3.sub([], coord0, coord1));\n      const l0Sqr = vec3.sqrLen(coord0);\n      const l1Sqr = vec3.sqrLen(coord1);\n      const sSqr = (4 * l0Sqr * l1Sqr - (lSqr - l0Sqr - l1Sqr) ** 2) / 16;\n      const dSqr = (4 * sSqr) / lSqr;\n      const r0 = Math.sqrt(l0Sqr - dSqr);\n      const dr = Math.sqrt(Math.max(0, lt * lt - dSqr));\n      const t = (r0 - dr) / Math.sqrt(lSqr);\n\n      coord = vec3.lerp([], coord0, coord1, t);\n    }\n    const [X, Y, Z] = this.unprojectPosition(coord);\n\n    if (Number.isFinite(z)) {\n      return [X, Y, Z];\n    }\n    return Number.isFinite(targetZ) ? [X, Y, targetZ] : [X, Y];\n  }\n\n  projectPosition(xyz) {\n    const [lng, lat, Z = 0] = xyz;\n    const lambda = lng * DEGREES_TO_RADIANS;\n    const phi = lat * DEGREES_TO_RADIANS;\n    const cosPhi = Math.cos(phi);\n    const D = (Z / EARTH_RADIUS + 1) * GLOBE_RADIUS;\n\n    return [Math.sin(lambda) * cosPhi * D, -Math.cos(lambda) * cosPhi * D, Math.sin(phi) * D];\n  }\n\n  unprojectPosition(xyz) {\n    const [x, y, z] = xyz;\n    const D = vec3.len(xyz);\n    const phi = Math.asin(z / D);\n    const lambda = Math.atan2(x, -y);\n\n    const lng = lambda * RADIANS_TO_DEGREES;\n    const lat = phi * RADIANS_TO_DEGREES;\n    const Z = (D / GLOBE_RADIUS - 1) * EARTH_RADIUS;\n    return [lng, lat, Z];\n  }\n\n  projectFlat(xyz) {\n    return xyz;\n  }\n\n  unprojectFlat(xyz) {\n    return xyz;\n  }\n\n  getMapCenterByLngLatPosition({lngLat, pos}) {\n    const fromPosition = this.unproject(pos);\n    return [\n      lngLat[0] - fromPosition[0] + this.longitude,\n      lngLat[1] - fromPosition[1] + this.latitude\n    ];\n  }\n}\n\nfunction transformVector(matrix, vector) {\n  const result = vec4.transformMat4([], vector, matrix);\n  vec4.scale(result, result, 1 / result[3]);\n  return result;\n}\n"],"file":"globe-viewport.js"}