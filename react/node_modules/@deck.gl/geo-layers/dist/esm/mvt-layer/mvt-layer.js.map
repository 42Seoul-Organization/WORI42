{"version":3,"sources":["../../../src/mvt-layer/mvt-layer.js"],"names":["Matrix4","MVTLoader","load","COORDINATE_SYSTEM","TileLayer","getURLFromTemplate","ClipExtension","WORLD_SIZE","defaultProps","uniqueIdProperty","type","value","highlightedFeatureId","MVTLayer","tile","url","props","data","Promise","reject","getLoadOptions","worldScale","Math","pow","z","xScale","yScale","xOffset","x","yOffset","y","modelMatrix","scale","autoHighlight","coordinateOrigin","coordinateSystem","CARTESIAN","extensions","info","pickingEvent","hoveredFeatureId","state","hoveredFeature","object","newHoveredFeatureId","getFeatureUniqueId","setState","isFeatureIdPresent","isFeatureIdDefined","Array","isArray","featureIdToHighlight","findIndex","feature","properties","id","undefined","layerName"],"mappings":"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","sourcesContent":["import {Matrix4} from 'math.gl';\nimport {MVTLoader} from '@loaders.gl/mvt';\nimport {load} from '@loaders.gl/core';\nimport {COORDINATE_SYSTEM} from '@deck.gl/core';\n\nimport TileLayer from '../tile-layer/tile-layer';\nimport {getURLFromTemplate} from '../tile-layer/utils';\nimport ClipExtension from './clip-extension';\n\nconst WORLD_SIZE = 512;\n\nconst defaultProps = {\n  uniqueIdProperty: {type: 'string', value: ''},\n  highlightedFeatureId: null\n};\n\nexport default class MVTLayer extends TileLayer {\n  getTileData(tile) {\n    const url = getURLFromTemplate(this.props.data, tile);\n    if (!url) {\n      return Promise.reject('Invalid URL');\n    }\n    return load(url, MVTLoader, this.getLoadOptions());\n  }\n\n  renderSubLayers(props) {\n    const {tile} = props;\n    const worldScale = Math.pow(2, tile.z);\n\n    const xScale = WORLD_SIZE / worldScale;\n    const yScale = -xScale;\n\n    const xOffset = (WORLD_SIZE * tile.x) / worldScale;\n    const yOffset = WORLD_SIZE * (1 - tile.y / worldScale);\n\n    const modelMatrix = new Matrix4().scale([xScale, yScale, 1]);\n\n    props.autoHighlight = false;\n    props.modelMatrix = modelMatrix;\n    props.coordinateOrigin = [xOffset, yOffset, 0];\n    props.coordinateSystem = COORDINATE_SYSTEM.CARTESIAN;\n    props.extensions = [...(props.extensions || []), new ClipExtension()];\n\n    return super.renderSubLayers(props);\n  }\n\n  onHover(info, pickingEvent) {\n    const {uniqueIdProperty, autoHighlight} = this.props;\n\n    if (autoHighlight) {\n      const {hoveredFeatureId} = this.state;\n      const hoveredFeature = info.object;\n      let newHoveredFeatureId;\n\n      if (hoveredFeature) {\n        newHoveredFeatureId = getFeatureUniqueId(hoveredFeature, uniqueIdProperty);\n      }\n\n      if (hoveredFeatureId !== newHoveredFeatureId) {\n        this.setState({hoveredFeatureId: newHoveredFeatureId});\n      }\n    }\n\n    return super.onHover(info, pickingEvent);\n  }\n\n  getHighlightedObjectIndex(tile) {\n    const {hoveredFeatureId} = this.state;\n    const {uniqueIdProperty, highlightedFeatureId} = this.props;\n    const {data} = tile;\n\n    const isFeatureIdPresent =\n      isFeatureIdDefined(hoveredFeatureId) || isFeatureIdDefined(highlightedFeatureId);\n\n    if (!isFeatureIdPresent || !Array.isArray(data)) {\n      return -1;\n    }\n\n    const featureIdToHighlight = isFeatureIdDefined(highlightedFeatureId)\n      ? highlightedFeatureId\n      : hoveredFeatureId;\n\n    return data.findIndex(\n      feature => getFeatureUniqueId(feature, uniqueIdProperty) === featureIdToHighlight\n    );\n  }\n}\n\nfunction getFeatureUniqueId(feature, uniqueIdProperty) {\n  if (uniqueIdProperty) {\n    return feature.properties[uniqueIdProperty];\n  }\n\n  if ('id' in feature) {\n    return feature.id;\n  }\n\n  return -1;\n}\n\nfunction isFeatureIdDefined(value) {\n  return value !== undefined && value !== null && value !== '';\n}\n\nMVTLayer.layerName = 'MVTLayer';\nMVTLayer.defaultProps = defaultProps;\n"],"file":"mvt-layer.js"}