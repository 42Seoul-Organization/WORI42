{"version":3,"sources":["../../../src/heatmap-layer/heatmap-layer.js"],"names":["getBounds","boundsContain","packVertices","scaleToAspectRatio","getTextureCoordinates","getTextureParams","Buffer","Texture2D","Transform","getParameters","FEATURES","hasFeatures","isWebGL2","AttributeManager","COORDINATE_SYSTEM","log","_mergeShaders","mergeShaders","project32","TriangleLayer","AggregationLayer","defaultColorRange","colorRangeToFlatArray","weights_vs","weights_fs","vs_max","RESOLUTION","SIZE_2K","ZOOM_DEBOUNCE","TEXTURE_OPTIONS","mipmaps","parameters","dataFormat","DEFAULT_COLOR_DOMAIN","defaultProps","getPosition","type","value","x","position","getWeight","intensity","min","radiusPixels","max","colorRange","threshold","colorDomain","optional","REQUIRED_FEATURES","BLEND_EQUATION_MINMAX","TEXTURE_FLOAT","DIMENSIONS","data","props","HeatmapLayer","initializeState","gl","context","setState","supported","error","id","_setupTextureParams","_setupAttributes","_setupResources","shouldUpdateState","changeFlags","somethingChanged","updateState","opts","state","oldProps","_getChangeFlags","viewportChanged","boundsChanged","_updateBounds","dataChanged","_updateWeightmap","viewportZoomChanged","_debouncedUpdateWeightmap","_updateColorTexture","_updateTextureRenderingBounds","viewport","weightsScale","domainScale","scale","map","Math","zoom","renderLayers","weightsTexture","triPositionBuffer","triTexCoordBuffer","maxWeightsTexture","colorTexture","updateTriggers","TriangleLayerClass","getSubLayerClass","getSubLayerProps","attributes","positions","texCoords","vertexCount","maxTexture","texture","finalizeState","weightsTransform","maxWeightTransform","updateTimer","delete","clearTimeout","_getAttributeManager","stats","dimensions","isAttributeChanged","isAggregationDirty","compareAll","dimension","_createTextures","textureSize","format","width","height","attributeManager","getAttributeManager","add","size","accessor","weights","positionAttributeName","floatTargetSupport","COLOR_ATTACHMENT_RGBA32F","warn","_createWeightsTransform","shaderOptions","shaders","vs","_fs","modules","elementCount","_targetTexture","_targetTextureVarying","_sourceTextures","inTexture","byteLength","updateShaders","_updateMaxWeightValue","run","blend","depthTest","blendFunc","blendEquation","forceUpdate","viewportCorners","unproject","visibleWorldBounds","newState","worldBounds","scaledCommonBounds","_worldToCommonBounds","_commonToWorldBounds","coordinateSystem","LNGLAT","normalizedCommonBounds","subData","textureBounds","p","projectPosition","colors","setImageData","length","commonBounds","useLayerCoordinateSystem","uniforms","textureWidth","update","getNumInstances","clearRenderTarget","getAttributes","moduleSettings","getModuleSettings","setParameters","lastUpdate","Date","now","fromTimer","timeSinceLastUpdate","setTimeout","bind","minLong","minLat","maxLong","maxLat","bottomLeftCommon","topRightCommon","slice","concat","xMin","yMin","xMax","yMax","bottomLeftWorld","unprojectPosition","topRightWorld","layerName"],"mappings":";;;;;;AAsBA,SACEA,SADF,EAEEC,aAFF,EAGEC,YAHF,EAIEC,kBAJF,EAKEC,qBALF,EAMEC,gBANF,QAOO,uBAPP;AAQA,SACEC,MADF,EAEEC,SAFF,EAGEC,SAHF,EAIEC,aAJF,EAKEC,QALF,EAMEC,WANF,EAOEC,QAPF,QAQO,eARP;AASA,SACEC,gBADF,EAEEC,iBAFF,EAGEC,GAHF,EAIEC,aAAa,IAAIC,YAJnB,EAKEC,SALF,QAMO,eANP;AAOA,OAAOC,aAAP,MAA0B,kBAA1B;AACA,OAAOC,gBAAP,MAA6B,sBAA7B;AACA,SAAQC,iBAAR,EAA2BC,qBAA3B,QAAuD,sBAAvD;AACA,OAAOC,UAAP,MAAuB,mBAAvB;AACA,OAAOC,UAAP,MAAuB,mBAAvB;AACA,OAAOC,MAAP,MAAmB,eAAnB;AAEA,MAAMC,UAAU,GAAG,CAAnB;AACA,MAAMC,OAAO,GAAG,IAAhB;AACA,MAAMC,aAAa,GAAG,GAAtB;AACA,MAAMC,eAAe,GAAG;AACtBC,EAAAA,OAAO,EAAE,KADa;AAEtBC,EAAAA,UAAU,EAAE;AACV,iBADU;AAEV,iBAFU;AAGV,kBAHU;AAIV;AAJU,GAFU;AAQtBC,EAAAA,UAAU;AARY,CAAxB;AAUA,MAAMC,oBAAoB,GAAG,CAAC,CAAD,EAAI,CAAJ,CAA7B;AAEA,MAAMC,YAAY,GAAG;AACnBC,EAAAA,WAAW,EAAE;AAACC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAEC,CAAC,IAAIA,CAAC,CAACC;AAAjC,GADM;AAEnBC,EAAAA,SAAS,EAAE;AAACJ,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE;AAA1B,GAFQ;AAGnBI,EAAAA,SAAS,EAAE;AAACL,IAAAA,IAAI,EAAE,QAAP;AAAiBM,IAAAA,GAAG,EAAE,CAAtB;AAAyBL,IAAAA,KAAK,EAAE;AAAhC,GAHQ;AAInBM,EAAAA,YAAY,EAAE;AAACP,IAAAA,IAAI,EAAE,QAAP;AAAiBM,IAAAA,GAAG,EAAE,CAAtB;AAAyBE,IAAAA,GAAG,EAAE,GAA9B;AAAmCP,IAAAA,KAAK,EAAE;AAA1C,GAJK;AAKnBQ,EAAAA,UAAU,EAAExB,iBALO;AAMnByB,EAAAA,SAAS,EAAE;AAACV,IAAAA,IAAI,EAAE,QAAP;AAAiBM,IAAAA,GAAG,EAAE,CAAtB;AAAyBE,IAAAA,GAAG,EAAE,CAA9B;AAAiCP,IAAAA,KAAK,EAAE;AAAxC,GANQ;AAOnBU,EAAAA,WAAW,EAAE;AAACX,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,KAAK,EAAE,IAAvB;AAA6BW,IAAAA,QAAQ,EAAE;AAAvC;AAPM,CAArB;AAUA,MAAMC,iBAAiB,GAAG,CACxBvC,QAAQ,CAACwC,qBADe,EAExBxC,QAAQ,CAACyC,aAFe,CAA1B;AAMA,MAAMC,UAAU,GAAG;AACjBC,EAAAA,IAAI,EAAE;AACJC,IAAAA,KAAK,EAAE,CAAC,cAAD;AADH;AADW,CAAnB;AAMA,eAAe,MAAMC,YAAN,SAA2BnC,gBAA3B,CAA4C;AACzDoC,EAAAA,eAAe,GAAG;AAChB,UAAM;AAACC,MAAAA;AAAD,QAAO,KAAKC,OAAlB;;AACA,QAAI,CAAC/C,WAAW,CAAC8C,EAAD,EAAKR,iBAAL,CAAhB,EAAyC;AACvC,WAAKU,QAAL,CAAc;AAACC,QAAAA,SAAS,EAAE;AAAZ,OAAd;AACA7C,MAAAA,GAAG,CAAC8C,KAAJ,yBAA2B,KAAKC,EAAhC;AACA;AACD;;AACD,UAAMN,eAAN,CAAsBJ,UAAtB;AACA,SAAKO,QAAL,CAAc;AAACC,MAAAA,SAAS,EAAE;AAAZ,KAAd;;AACA,SAAKG,mBAAL;;AACA,SAAKC,gBAAL;;AACA,SAAKC,eAAL;AACD;;AAEDC,EAAAA,iBAAiB,CAAC;AAACC,IAAAA;AAAD,GAAD,EAAgB;AAE/B,WAAOA,WAAW,CAACC,gBAAnB;AACD;;AAGDC,EAAAA,WAAW,CAACC,IAAD,EAAO;AAChB,QAAI,CAAC,KAAKC,KAAL,CAAWX,SAAhB,EAA2B;AACzB;AACD;;AACD,UAAMS,WAAN,CAAkBC,IAAlB;AACA,UAAM;AAAChB,MAAAA,KAAD;AAAQkB,MAAAA;AAAR,QAAoBF,IAA1B;;AACA,UAAMH,WAAW,GAAG,KAAKM,eAAL,CAAqBH,IAArB,CAApB;;AAEA,QAAIH,WAAW,CAACO,eAAhB,EAAiC;AAC/BP,MAAAA,WAAW,CAACQ,aAAZ,GAA4B,KAAKC,aAAL,EAA5B;AACD;;AAED,QAAIT,WAAW,CAACU,WAAZ,IAA2BV,WAAW,CAACQ,aAA3C,EAA0D;AACxD,WAAKG,gBAAL;AACD,KAFD,MAEO,IAAIX,WAAW,CAACY,mBAAhB,EAAqC;AAC1C,WAAKC,yBAAL;AACD;;AAED,QAAI1B,KAAK,CAACT,UAAN,KAAqB2B,QAAQ,CAAC3B,UAAlC,EAA8C;AAC5C,WAAKoC,mBAAL,CAAyBX,IAAzB;AACD;;AAED,QAAIH,WAAW,CAACO,eAAhB,EAAiC;AAC/B,WAAKQ,6BAAL;AACD;;AAED,QAAIV,QAAQ,CAACzB,WAAT,KAAyBO,KAAK,CAACP,WAA/B,IAA8CoB,WAAW,CAACO,eAA9D,EAA+E;AAC7E,YAAM;AAACS,QAAAA;AAAD,UAAa,KAAKzB,OAAxB;AACA,YAAM;AAAC0B,QAAAA;AAAD,UAAiB,KAAKb,KAA5B;AACA,YAAMc,WAAW,GAAG,CAACF,QAAQ,GAAG,OAAOA,QAAQ,CAACG,KAAnB,GAA2B,CAApC,IAAyCF,YAA7D;AACA,YAAMrC,WAAW,GAAGO,KAAK,CAACP,WAAN,GAChBO,KAAK,CAACP,WAAN,CAAkBwC,GAAlB,CAAsBjD,CAAC,IAAIA,CAAC,GAAG+C,WAA/B,CADgB,GAEhBpD,oBAFJ;;AAGA,UAAIc,WAAW,CAAC,CAAD,CAAX,GAAiB,CAAjB,IAAsBqC,YAAY,GAAG,CAAzC,EAA4C;AAG1C,cAAMxC,GAAG,GAAG4C,IAAI,CAAC9C,GAAL,CAASK,WAAW,CAAC,CAAD,CAApB,EAAyB,CAAzB,CAAZ;AACAA,QAAAA,WAAW,CAAC,CAAD,CAAX,IAAkBH,GAAG,GAAGG,WAAW,CAAC,CAAD,CAAnC;AACAA,QAAAA,WAAW,CAAC,CAAD,CAAX,GAAiBH,GAAjB;AACD;;AACD,WAAKe,QAAL,CAAc;AAACZ,QAAAA;AAAD,OAAd;AACD;;AAED,SAAKY,QAAL,CAAc;AAAC8B,MAAAA,IAAI,EAAEnB,IAAI,CAACZ,OAAL,CAAayB,QAAb,CAAsBM;AAA7B,KAAd;AACD;;AAGDC,EAAAA,YAAY,GAAG;AACb,QAAI,CAAC,KAAKnB,KAAL,CAAWX,SAAhB,EAA2B;AACzB,aAAO,EAAP;AACD;;AACD,UAAM;AACJ+B,MAAAA,cADI;AAEJC,MAAAA,iBAFI;AAGJC,MAAAA,iBAHI;AAIJC,MAAAA,iBAJI;AAKJC,MAAAA,YALI;AAMJhD,MAAAA;AANI,QAOF,KAAKwB,KAPT;AAQA,UAAM;AAACyB,MAAAA,cAAD;AAAiBvD,MAAAA,SAAjB;AAA4BK,MAAAA;AAA5B,QAAyC,KAAKQ,KAApD;AAEA,UAAM2C,kBAAkB,GAAG,KAAKC,gBAAL,CAAsB,UAAtB,EAAkC/E,aAAlC,CAA3B;AAEA,WAAO,IAAI8E,kBAAJ,CACL,KAAKE,gBAAL,CAAsB;AACpBrC,MAAAA,EAAE,EAAE,gBADgB;AAEpBkC,MAAAA;AAFoB,KAAtB,CADK,EAKL;AACE3C,MAAAA,IAAI,EAAE;AACJ+C,QAAAA,UAAU,EAAE;AACVC,UAAAA,SAAS,EAAET,iBADD;AAEVU,UAAAA,SAAS,EAAET;AAFD;AADR,OADR;AAOEU,MAAAA,WAAW,EAAE,CAPf;AAQEC,MAAAA,UAAU,EAAEV,iBARd;AASEC,MAAAA,YATF;AAUEU,MAAAA,OAAO,EAAEd,cAVX;AAWElD,MAAAA,SAXF;AAYEK,MAAAA,SAZF;AAaEC,MAAAA;AAbF,KALK,CAAP;AAqBD;;AAED2D,EAAAA,aAAa,GAAG;AACd,UAAMA,aAAN;AACA,UAAM;AACJC,MAAAA,gBADI;AAEJhB,MAAAA,cAFI;AAGJiB,MAAAA,kBAHI;AAIJd,MAAAA,iBAJI;AAKJF,MAAAA,iBALI;AAMJC,MAAAA,iBANI;AAOJE,MAAAA,YAPI;AAQJc,MAAAA;AARI,QASF,KAAKtC,KATT;AAWAoC,IAAAA,gBAAgB,IAAIA,gBAAgB,CAACG,MAAjB,EAApB;AACAnB,IAAAA,cAAc,IAAIA,cAAc,CAACmB,MAAf,EAAlB;AACAF,IAAAA,kBAAkB,IAAIA,kBAAkB,CAACE,MAAnB,EAAtB;AACAhB,IAAAA,iBAAiB,IAAIA,iBAAiB,CAACgB,MAAlB,EAArB;AACAlB,IAAAA,iBAAiB,IAAIA,iBAAiB,CAACkB,MAAlB,EAArB;AACAjB,IAAAA,iBAAiB,IAAIA,iBAAiB,CAACiB,MAAlB,EAArB;AACAf,IAAAA,YAAY,IAAIA,YAAY,CAACe,MAAb,EAAhB;AACAD,IAAAA,WAAW,IAAIE,YAAY,CAACF,WAAD,CAA3B;AAED;;AAKDG,EAAAA,oBAAoB,GAAG;AACrB,WAAO,IAAInG,gBAAJ,CAAqB,KAAK6C,OAAL,CAAaD,EAAlC,EAAsC;AAC3CK,MAAAA,EAAE,EAAE,KAAKR,KAAL,CAAWQ,EAD4B;AAE3CmD,MAAAA,KAAK,EAAE,KAAKvD,OAAL,CAAauD;AAFuB,KAAtC,CAAP;AAID;;AAEDxC,EAAAA,eAAe,CAACH,IAAD,EAAO;AACpB,UAAMH,WAAW,GAAG,EAApB;AACA,UAAM;AAAC+C,MAAAA;AAAD,QAAe,KAAK3C,KAA1B;AACAJ,IAAAA,WAAW,CAACU,WAAZ,GACE,KAAKsC,kBAAL,MACA,KAAKC,kBAAL,CAAwB9C,IAAxB,EAA8B;AAC5B+C,MAAAA,UAAU,EAAE,IADgB;AAE5BC,MAAAA,SAAS,EAAEJ,UAAU,CAAC7D;AAFM,KAA9B,CAFF;AAMAc,IAAAA,WAAW,CAACO,eAAZ,GAA8BJ,IAAI,CAACH,WAAL,CAAiBO,eAA/C;AAEA,UAAM;AAACe,MAAAA;AAAD,QAAS,KAAKlB,KAApB;;AACA,QAAI,CAACD,IAAI,CAACZ,OAAL,CAAayB,QAAd,IAA0Bb,IAAI,CAACZ,OAAL,CAAayB,QAAb,CAAsBM,IAAtB,KAA+BA,IAA7D,EAAmE;AACjEtB,MAAAA,WAAW,CAACY,mBAAZ,GAAkC,IAAlC;AACD;;AAED,WAAOZ,WAAP;AACD;;AAEDoD,EAAAA,eAAe,GAAG;AAChB,UAAM;AAAC9D,MAAAA;AAAD,QAAO,KAAKC,OAAlB;AACA,UAAM;AAAC8D,MAAAA,WAAD;AAAcC,MAAAA,MAAd;AAAsBrF,MAAAA;AAAtB,QAA8B,KAAKmC,KAAzC;AAEA,SAAKZ,QAAL,CAAc;AACZgC,MAAAA,cAAc,EAAE,IAAIpF,SAAJ,CAAckD,EAAd;AACdiE,QAAAA,KAAK,EAAEF,WADO;AAEdG,QAAAA,MAAM,EAAEH,WAFM;AAGdC,QAAAA,MAHc;AAIdrF,QAAAA;AAJc,SAKXP,eALW,EADJ;AAQZiE,MAAAA,iBAAiB,EAAE,IAAIvF,SAAJ,CAAckD,EAAd;AAAmBgE,QAAAA,MAAnB;AAA2BrF,QAAAA;AAA3B,SAAoCP,eAApC;AARP,KAAd;AAUD;;AAEDmC,EAAAA,gBAAgB,GAAG;AACjB,UAAM4D,gBAAgB,GAAG,KAAKC,mBAAL,EAAzB;AACAD,IAAAA,gBAAgB,CAACE,GAAjB,CAAqB;AACnBzB,MAAAA,SAAS,EAAE;AAAC0B,QAAAA,IAAI,EAAE,CAAP;AAAUC,QAAAA,QAAQ,EAAE;AAApB,OADQ;AAEnBC,MAAAA,OAAO,EAAE;AAACF,QAAAA,IAAI,EAAE,CAAP;AAAUC,QAAAA,QAAQ,EAAE;AAApB;AAFU,KAArB;AAIA,SAAKrE,QAAL,CAAc;AAACuE,MAAAA,qBAAqB,EAAE;AAAxB,KAAd;AACD;;AAEDnE,EAAAA,mBAAmB,GAAG;AACpB,UAAM;AAACN,MAAAA;AAAD,QAAO,KAAKC,OAAlB;AACA,UAAM8D,WAAW,GAAGhC,IAAI,CAAC9C,GAAL,CAASf,OAAT,EAAkBlB,aAAa,CAACgD,EAAD,OAA/B,CAApB;AACA,UAAM0E,kBAAkB,GAAGxH,WAAW,CAAC8C,EAAD,EAAK/C,QAAQ,CAAC0H,wBAAd,CAAtC;AACA,UAAM;AAACX,MAAAA,MAAD;AAASrF,MAAAA;AAAT,QAAiB/B,gBAAgB,CAAC;AAACoD,MAAAA,EAAD;AAAK0E,MAAAA;AAAL,KAAD,CAAvC;AACA,UAAM/C,YAAY,GAAG+C,kBAAkB,GAAG,CAAH,GAAO,IAAI,GAAlD;AACA,SAAKxE,QAAL,CAAc;AAAC6D,MAAAA,WAAD;AAAcC,MAAAA,MAAd;AAAsBrF,MAAAA,IAAtB;AAA4BgD,MAAAA;AAA5B,KAAd;;AACA,QAAI,CAAC+C,kBAAL,EAAyB;AACvBpH,MAAAA,GAAG,CAACsH,IAAJ,yBAEI,KAAKvE,EAFT;AAKD;AACF;;AAEDwE,EAAAA,uBAAuB,CAACC,aAAa,GAAG,EAAjB,EAAqB;AAC1C,UAAM;AAAC9E,MAAAA;AAAD,QAAO,KAAKC,OAAlB;AACA,QAAI;AAACiD,MAAAA;AAAD,QAAqB,KAAKpC,KAA9B;AACA,UAAM;AAACoB,MAAAA;AAAD,QAAmB,KAAKpB,KAA9B;;AACA,QAAIoC,gBAAJ,EAAsB;AACpBA,MAAAA,gBAAgB,CAACG,MAAjB;AACD;;AACD,UAAM0B,OAAO,GAAGvH,YAAY,CAC1B;AACEwH,MAAAA,EAAE,EAAElH,UADN;AAEEmH,MAAAA,GAAG,EAAElH,UAFP;AAGEmH,MAAAA,OAAO,EAAE,CAACzH,SAAD;AAHX,KAD0B,EAM1BqH,aAN0B,CAA5B;AASA5B,IAAAA,gBAAgB,GAAG,IAAInG,SAAJ,CAAciD,EAAd;AACjBK,MAAAA,EAAE,YAAK,KAAKA,EAAV,uBADe;AAEjB8E,MAAAA,YAAY,EAAE,CAFG;AAGjBC,MAAAA,cAAc,EAAElD,cAHC;AAIjBmD,MAAAA,qBAAqB,EAAE;AAJN,OAKdN,OALc,EAAnB;AAOA,SAAK7E,QAAL,CAAc;AAACgD,MAAAA;AAAD,KAAd;AACD;;AAED1C,EAAAA,eAAe,GAAG;AAChB,UAAM;AAACR,MAAAA;AAAD,QAAO,KAAKC,OAAlB;;AACA,SAAK6D,eAAL;;AACA,UAAM;AAACC,MAAAA,WAAD;AAAc7B,MAAAA,cAAd;AAA8BG,MAAAA;AAA9B,QAAmD,KAAKvB,KAA9D;;AACA,SAAK+D,uBAAL;;AACA,UAAM1B,kBAAkB,GAAG,IAAIpG,SAAJ,CAAciD,EAAd,EAAkB;AAC3CK,MAAAA,EAAE,YAAK,KAAKA,EAAV,2BADyC;AAE3CiF,MAAAA,eAAe,EAAE;AACfC,QAAAA,SAAS,EAAErD;AADI,OAF0B;AAK3CkD,MAAAA,cAAc,EAAE/C,iBAL2B;AAM3CgD,MAAAA,qBAAqB,EAAE,YANoB;AAO3CL,MAAAA,EAAE,EAAEhH,MAPuC;AAQ3CmH,MAAAA,YAAY,EAAEpB,WAAW,GAAGA;AARe,KAAlB,CAA3B;AAWA,SAAK7D,QAAL,CAAc;AACZgC,MAAAA,cADY;AAEZG,MAAAA,iBAFY;AAGZc,MAAAA,kBAHY;AAIZnB,MAAAA,IAAI,EAAE,IAJM;AAKZG,MAAAA,iBAAiB,EAAE,IAAItF,MAAJ,CAAWmD,EAAX,EAAe;AAChCwF,QAAAA,UAAU,EAAE,EADoB;AAEhCjB,QAAAA,QAAQ,EAAE;AAACD,UAAAA,IAAI,EAAE;AAAP;AAFsB,OAAf,CALP;AASZlC,MAAAA,iBAAiB,EAAE,IAAIvF,MAAJ,CAAWmD,EAAX,EAAe;AAChCwF,QAAAA,UAAU,EAAE,EADoB;AAEhCjB,QAAAA,QAAQ,EAAE;AAACD,UAAAA,IAAI,EAAE;AAAP;AAFsB,OAAf;AATP,KAAd;AAcD;;AAGDmB,EAAAA,aAAa,CAACX,aAAD,EAAgB;AAE3B,SAAKD,uBAAL,CAA6BC,aAA7B;AACD;;AAEDY,EAAAA,qBAAqB,GAAG;AACtB,UAAM;AAACvC,MAAAA;AAAD,QAAuB,KAAKrC,KAAlC;AACAqC,IAAAA,kBAAkB,CAACwC,GAAnB,CAAuB;AACrBrH,MAAAA,UAAU,EAAE;AACVsH,QAAAA,KAAK,EAAE,IADG;AAEVC,QAAAA,SAAS,EAAE,KAFD;AAGVC,QAAAA,SAAS,EAAE,MAHD;AAIVC,QAAAA,aAAa;AAJH;AADS,KAAvB;AAQD;;AAGD5E,EAAAA,aAAa,CAAC6E,WAAW,GAAG,KAAf,EAAsB;AACjC,UAAM;AAACtE,MAAAA;AAAD,QAAa,KAAKzB,OAAxB;AAIA,UAAMgG,eAAe,GAAG,CACtBvE,QAAQ,CAACwE,SAAT,CAAmB,CAAC,CAAD,EAAI,CAAJ,CAAnB,CADsB,EAEtBxE,QAAQ,CAACwE,SAAT,CAAmB,CAACxE,QAAQ,CAACuC,KAAV,EAAiB,CAAjB,CAAnB,CAFsB,EAGtBvC,QAAQ,CAACwE,SAAT,CAAmB,CAACxE,QAAQ,CAACuC,KAAV,EAAiBvC,QAAQ,CAACwC,MAA1B,CAAnB,CAHsB,EAItBxC,QAAQ,CAACwE,SAAT,CAAmB,CAAC,CAAD,EAAIxE,QAAQ,CAACwC,MAAb,CAAnB,CAJsB,CAAxB;AAQA,UAAMiC,kBAAkB,GAAG5J,SAAS,CAAC0J,eAAD,CAApC;AAEA,UAAMG,QAAQ,GAAG;AAACD,MAAAA,kBAAD;AAAqBF,MAAAA;AAArB,KAAjB;AACA,QAAI/E,aAAa,GAAG,KAApB;;AAEA,QACE8E,WAAW,IACX,CAAC,KAAKlF,KAAL,CAAWuF,WADZ,IAEA,CAAC7J,aAAa,CAAC,KAAKsE,KAAL,CAAWuF,WAAZ,EAAyBF,kBAAzB,CAHhB,EAIE;AAGA,YAAMG,kBAAkB,GAAG,KAAKC,oBAAL,CAA0BJ,kBAA1B,CAA3B;;AAGA,YAAME,WAAW,GAAG,KAAKG,oBAAL,CAA0BF,kBAA1B,CAApB;;AAGA,UAAI,KAAKzG,KAAL,CAAW4G,gBAAX,KAAgCpJ,iBAAiB,CAACqJ,MAAtD,EAA8D;AAC5DL,QAAAA,WAAW,CAAC,CAAD,CAAX,GAAiBtE,IAAI,CAAC5C,GAAL,CAASkH,WAAW,CAAC,CAAD,CAApB,EAAyB,CAAC,SAA1B,CAAjB;AACAA,QAAAA,WAAW,CAAC,CAAD,CAAX,GAAiBtE,IAAI,CAAC9C,GAAL,CAASoH,WAAW,CAAC,CAAD,CAApB,EAAyB,SAAzB,CAAjB;AACAA,QAAAA,WAAW,CAAC,CAAD,CAAX,GAAiBtE,IAAI,CAAC5C,GAAL,CAASkH,WAAW,CAAC,CAAD,CAApB,EAAyB,CAAC,GAA1B,CAAjB;AACAA,QAAAA,WAAW,CAAC,CAAD,CAAX,GAAiBtE,IAAI,CAAC9C,GAAL,CAASoH,WAAW,CAAC,CAAD,CAApB,EAAyB,GAAzB,CAAjB;AACD;;AAGD,YAAMM,sBAAsB,GAAG,KAAKJ,oBAAL,CAA0BF,WAA1B,CAA/B;;AAEAD,MAAAA,QAAQ,CAACC,WAAT,GAAuBA,WAAvB;AACAD,MAAAA,QAAQ,CAACO,sBAAT,GAAkCA,sBAAlC;AAEAzF,MAAAA,aAAa,GAAG,IAAhB;AACD;;AACD,SAAKhB,QAAL,CAAckG,QAAd;AACA,WAAOlF,aAAP;AACD;;AAEDO,EAAAA,6BAA6B,GAAG;AAE9B,UAAM;AACJU,MAAAA,iBADI;AAEJC,MAAAA,iBAFI;AAGJuE,MAAAA,sBAHI;AAIJV,MAAAA;AAJI,QAKF,KAAKnF,KALT;AAOA,UAAM;AAACY,MAAAA;AAAD,QAAa,KAAKzB,OAAxB;AAEAkC,IAAAA,iBAAiB,CAACyE,OAAlB,CAA0BnK,YAAY,CAACwJ,eAAD,EAAkB,CAAlB,CAAtC;AAEA,UAAMY,aAAa,GAAGZ,eAAe,CAACnE,GAAhB,CAAoBgF,CAAC,IACzCnK,qBAAqB,CAAC+E,QAAQ,CAACqF,eAAT,CAAyBD,CAAzB,CAAD,EAA8BH,sBAA9B,CADD,CAAtB;AAGAvE,IAAAA,iBAAiB,CAACwE,OAAlB,CAA0BnK,YAAY,CAACoK,aAAD,EAAgB,CAAhB,CAAtC;AACD;;AAEDrF,EAAAA,mBAAmB,CAACX,IAAD,EAAO;AACxB,UAAM;AAACzB,MAAAA;AAAD,QAAeyB,IAAI,CAAChB,KAA1B;AACA,QAAI;AAACyC,MAAAA;AAAD,QAAiB,KAAKxB,KAA1B;AACA,UAAMkG,MAAM,GAAGnJ,qBAAqB,CAACuB,UAAD,EAAa,IAAb,CAApC;;AAEA,QAAIkD,YAAJ,EAAkB;AAChBA,MAAAA,YAAY,CAAC2E,YAAb,CAA0B;AACxBrH,QAAAA,IAAI,EAAEoH,MADkB;AAExB/C,QAAAA,KAAK,EAAE7E,UAAU,CAAC8H;AAFM,OAA1B;AAID,KALD,MAKO;AACL5E,MAAAA,YAAY,GAAG,IAAIxF,SAAJ,CAAc,KAAKmD,OAAL,CAAaD,EAA3B;AACbJ,QAAAA,IAAI,EAAEoH,MADO;AAEb/C,QAAAA,KAAK,EAAE7E,UAAU,CAAC8H,MAFL;AAGbhD,QAAAA,MAAM,EAAE,CAHK;AAIbF,QAAAA,MAAM,EAAE7G,QAAQ,CAAC,KAAK8C,OAAL,CAAaD,EAAd,CAAR,eAJK;AAKbrB,QAAAA,IAAI;AALS,SAMVP,eANU,EAAf;AAQD;;AACD,SAAK8B,QAAL,CAAc;AAACoC,MAAAA;AAAD,KAAd;AACD;;AAEDjB,EAAAA,gBAAgB,GAAG;AACjB,UAAM;AAACnC,MAAAA;AAAD,QAAiB,KAAKW,KAA5B;AACA,UAAM;AAACqD,MAAAA,gBAAD;AAAmBmD,MAAAA,WAAnB;AAAgCtC,MAAAA,WAAhC;AAA6C7B,MAAAA,cAA7C;AAA6DP,MAAAA;AAA7D,QAA6E,KAAKb,KAAxF;;AAGA,UAAMqG,YAAY,GAAG,KAAKZ,oBAAL,CAA0BF,WAA1B,EAAuC;AAC1De,MAAAA,wBAAwB,EAAE;AADgC,KAAvC,CAArB;;AAIA,UAAMC,QAAQ,GAAG;AACfnI,MAAAA,YADe;AAEfiI,MAAAA,YAFe;AAGfG,MAAAA,YAAY,EAAEvD,WAHC;AAIfpC,MAAAA;AAJe,KAAjB;AAQAuB,IAAAA,gBAAgB,CAACqE,MAAjB,CAAwB;AACtBpC,MAAAA,YAAY,EAAE,KAAKqC,eAAL;AADQ,KAAxB;AAGAtE,IAAAA,gBAAgB,CAACyC,GAAjB,CAAqB;AACnB0B,MAAAA,QADmB;AAEnB/I,MAAAA,UAAU,EAAE;AACVsH,QAAAA,KAAK,EAAE,IADG;AAEVC,QAAAA,SAAS,EAAE,KAFD;AAGVC,QAAAA,SAAS,EAAE,MAHD;AAIVC,QAAAA,aAAa;AAJH,OAFO;AAQnB0B,MAAAA,iBAAiB,EAAE,IARA;AASnB9E,MAAAA,UAAU,EAAE,KAAK+E,aAAL,EATO;AAUnBC,MAAAA,cAAc,EAAE,KAAKC,iBAAL;AAVG,KAArB;;AAYA,SAAKlC,qBAAL;;AAGAxD,IAAAA,cAAc,CAAC2F,aAAf,CAA6B;AAC3B,mBAD2B;AAE3B;AAF2B,KAA7B;AAKA,SAAK3H,QAAL,CAAc;AAAC4H,MAAAA,UAAU,EAAEC,IAAI,CAACC,GAAL;AAAb,KAAd;AACD;;AAEDzG,EAAAA,yBAAyB,CAAC0G,SAAS,GAAG,KAAb,EAAoB;AAC3C,QAAI;AAAC7E,MAAAA;AAAD,QAAgB,KAAKtC,KAAzB;AACA,UAAMoH,mBAAmB,GAAGH,IAAI,CAACC,GAAL,KAAa,KAAKlH,KAAL,CAAWgH,UAApD;;AAEA,QAAIG,SAAJ,EAAe;AACb7E,MAAAA,WAAW,GAAG,IAAd;AACD;;AAED,QAAI8E,mBAAmB,IAAI/J,aAA3B,EAA0C;AAExC,WAAKgD,aAAL,CAAmB,IAAnB;;AACA,WAAKE,gBAAL;;AACA,WAAKI,6BAAL;AACD,KALD,MAKO,IAAI,CAAC2B,WAAL,EAAkB;AACvBA,MAAAA,WAAW,GAAG+E,UAAU,CACtB,KAAK5G,yBAAL,CAA+B6G,IAA/B,CAAoC,IAApC,EAA0C,IAA1C,CADsB,EAEtBjK,aAAa,GAAG+J,mBAFM,CAAxB;AAID;;AAED,SAAKhI,QAAL,CAAc;AAACkD,MAAAA;AAAD,KAAd;AACD;;AAKDmD,EAAAA,oBAAoB,CAACF,WAAD,EAAcxF,IAAI,GAAG,EAArB,EAAyB;AAC3C,UAAM;AAACuG,MAAAA,wBAAwB,GAAG;AAA5B,QAAqCvG,IAA3C;AACA,UAAM,CAACwH,OAAD,EAAUC,MAAV,EAAkBC,OAAlB,EAA2BC,MAA3B,IAAqCnC,WAA3C;AACA,UAAM;AAAC3E,MAAAA;AAAD,QAAa,KAAKzB,OAAxB;AACA,UAAM;AAAC8D,MAAAA;AAAD,QAAgB,KAAKjD,KAA3B;AAEA,UAAMwD,IAAI,GAAIP,WAAW,GAAG9F,UAAf,GAA6ByD,QAAQ,CAACG,KAAnD;AAEA,QAAI4G,gBAAJ;AACA,QAAIC,cAAJ;;AAGA,QAAItB,wBAAJ,EAA8B;AAC5BqB,MAAAA,gBAAgB,GAAG,KAAK1B,eAAL,CAAqB,CAACsB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAArB,CAAnB;AACAI,MAAAA,cAAc,GAAG,KAAK3B,eAAL,CAAqB,CAACwB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAArB,CAAjB;AACD,KAHD,MAGO;AACLC,MAAAA,gBAAgB,GAAG/G,QAAQ,CAACqF,eAAT,CAAyB,CAACsB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAAzB,CAAnB;AACAI,MAAAA,cAAc,GAAGhH,QAAQ,CAACqF,eAAT,CAAyB,CAACwB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAAzB,CAAjB;AACD;;AAED,QAAIrB,YAAY,GAAGsB,gBAAgB,CAACE,KAAjB,CAAuB,CAAvB,EAA0B,CAA1B,EAA6BC,MAA7B,CAAoCF,cAAc,CAACC,KAAf,CAAqB,CAArB,EAAwB,CAAxB,CAApC,CAAnB;AACAxB,IAAAA,YAAY,GAAGzK,kBAAkB,CAACyK,YAAD,EAAe7C,IAAf,EAAqBA,IAArB,CAAjC;AACA,WAAO6C,YAAP;AACD;;AAIDX,EAAAA,oBAAoB,CAACW,YAAD,EAAe;AACjC,UAAM,CAAC0B,IAAD,EAAOC,IAAP,EAAaC,IAAb,EAAmBC,IAAnB,IAA2B7B,YAAjC;AACA,UAAM;AAACzF,MAAAA;AAAD,QAAa,KAAKzB,OAAxB;AACA,UAAMgJ,eAAe,GAAGvH,QAAQ,CAACwH,iBAAT,CAA2B,CAACL,IAAD,EAAOC,IAAP,CAA3B,CAAxB;AACA,UAAMK,aAAa,GAAGzH,QAAQ,CAACwH,iBAAT,CAA2B,CAACH,IAAD,EAAOC,IAAP,CAA3B,CAAtB;AAEA,WAAOC,eAAe,CAACN,KAAhB,CAAsB,CAAtB,EAAyB,CAAzB,EAA4BC,MAA5B,CAAmCO,aAAa,CAACR,KAAd,CAAoB,CAApB,EAAuB,CAAvB,CAAnC,CAAP;AACD;;AAzdwD;AA4d3D7I,YAAY,CAACsJ,SAAb,GAAyB,cAAzB;AACAtJ,YAAY,CAACrB,YAAb,GAA4BA,YAA5B","sourcesContent":["// Copyright (c) 2015 - 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global setTimeout clearTimeout */\nimport GL from '@luma.gl/constants';\nimport {\n  getBounds,\n  boundsContain,\n  packVertices,\n  scaleToAspectRatio,\n  getTextureCoordinates,\n  getTextureParams\n} from './heatmap-layer-utils';\nimport {\n  Buffer,\n  Texture2D,\n  Transform,\n  getParameters,\n  FEATURES,\n  hasFeatures,\n  isWebGL2\n} from '@luma.gl/core';\nimport {\n  AttributeManager,\n  COORDINATE_SYSTEM,\n  log,\n  _mergeShaders as mergeShaders,\n  project32\n} from '@deck.gl/core';\nimport TriangleLayer from './triangle-layer';\nimport AggregationLayer from '../aggregation-layer';\nimport {defaultColorRange, colorRangeToFlatArray} from '../utils/color-utils';\nimport weights_vs from './weights-vs.glsl';\nimport weights_fs from './weights-fs.glsl';\nimport vs_max from './max-vs.glsl';\n\nconst RESOLUTION = 2; // (number of common space pixels) / (number texels)\nconst SIZE_2K = 2048;\nconst ZOOM_DEBOUNCE = 500; // milliseconds\nconst TEXTURE_OPTIONS = {\n  mipmaps: false,\n  parameters: {\n    [GL.TEXTURE_MAG_FILTER]: GL.LINEAR,\n    [GL.TEXTURE_MIN_FILTER]: GL.LINEAR,\n    [GL.TEXTURE_WRAP_S]: GL.CLAMP_TO_EDGE,\n    [GL.TEXTURE_WRAP_T]: GL.CLAMP_TO_EDGE\n  },\n  dataFormat: GL.RGBA\n};\nconst DEFAULT_COLOR_DOMAIN = [0, 0];\n\nconst defaultProps = {\n  getPosition: {type: 'accessor', value: x => x.position},\n  getWeight: {type: 'accessor', value: 1},\n  intensity: {type: 'number', min: 0, value: 1},\n  radiusPixels: {type: 'number', min: 1, max: 100, value: 50},\n  colorRange: defaultColorRange,\n  threshold: {type: 'number', min: 0, max: 1, value: 0.05},\n  colorDomain: {type: 'array', value: null, optional: true}\n};\n\nconst REQUIRED_FEATURES = [\n  FEATURES.BLEND_EQUATION_MINMAX, // max weight calculation\n  FEATURES.TEXTURE_FLOAT // weight-map as texture\n  // FEATURES.FLOAT_BLEND, // implictly supported when TEXTURE_FLOAT is supported\n];\n\nconst DIMENSIONS = {\n  data: {\n    props: ['radiusPixels']\n  }\n};\n\nexport default class HeatmapLayer extends AggregationLayer {\n  initializeState() {\n    const {gl} = this.context;\n    if (!hasFeatures(gl, REQUIRED_FEATURES)) {\n      this.setState({supported: false});\n      log.error(`HeatmapLayer: ${this.id} is not supported on this browser`)();\n      return;\n    }\n    super.initializeState(DIMENSIONS);\n    this.setState({supported: true});\n    this._setupTextureParams();\n    this._setupAttributes();\n    this._setupResources();\n  }\n\n  shouldUpdateState({changeFlags}) {\n    // Need to be updated when viewport changes\n    return changeFlags.somethingChanged;\n  }\n\n  /* eslint-disable complexity */\n  updateState(opts) {\n    if (!this.state.supported) {\n      return;\n    }\n    super.updateState(opts);\n    const {props, oldProps} = opts;\n    const changeFlags = this._getChangeFlags(opts);\n\n    if (changeFlags.viewportChanged) {\n      changeFlags.boundsChanged = this._updateBounds();\n    }\n\n    if (changeFlags.dataChanged || changeFlags.boundsChanged) {\n      this._updateWeightmap();\n    } else if (changeFlags.viewportZoomChanged) {\n      this._debouncedUpdateWeightmap();\n    }\n\n    if (props.colorRange !== oldProps.colorRange) {\n      this._updateColorTexture(opts);\n    }\n\n    if (changeFlags.viewportChanged) {\n      this._updateTextureRenderingBounds();\n    }\n\n    if (oldProps.colorDomain !== props.colorDomain || changeFlags.viewportChanged) {\n      const {viewport} = this.context;\n      const {weightsScale} = this.state;\n      const domainScale = (viewport ? 1024 / viewport.scale : 1) * weightsScale;\n      const colorDomain = props.colorDomain\n        ? props.colorDomain.map(x => x * domainScale)\n        : DEFAULT_COLOR_DOMAIN;\n      if (colorDomain[1] > 0 && weightsScale < 1) {\n        // Hack - when low precision texture is used, aggregated weights are in the [0, 1]\n        // range. Scale colorDomain to fit.\n        const max = Math.min(colorDomain[1], 1);\n        colorDomain[0] *= max / colorDomain[1];\n        colorDomain[1] = max;\n      }\n      this.setState({colorDomain});\n    }\n\n    this.setState({zoom: opts.context.viewport.zoom});\n  }\n  /* eslint-enable complexity */\n\n  renderLayers() {\n    if (!this.state.supported) {\n      return [];\n    }\n    const {\n      weightsTexture,\n      triPositionBuffer,\n      triTexCoordBuffer,\n      maxWeightsTexture,\n      colorTexture,\n      colorDomain\n    } = this.state;\n    const {updateTriggers, intensity, threshold} = this.props;\n\n    const TriangleLayerClass = this.getSubLayerClass('triangle', TriangleLayer);\n\n    return new TriangleLayerClass(\n      this.getSubLayerProps({\n        id: 'triangle-layer',\n        updateTriggers\n      }),\n      {\n        data: {\n          attributes: {\n            positions: triPositionBuffer,\n            texCoords: triTexCoordBuffer\n          }\n        },\n        vertexCount: 4,\n        maxTexture: maxWeightsTexture,\n        colorTexture,\n        texture: weightsTexture,\n        intensity,\n        threshold,\n        colorDomain\n      }\n    );\n  }\n\n  finalizeState() {\n    super.finalizeState();\n    const {\n      weightsTransform,\n      weightsTexture,\n      maxWeightTransform,\n      maxWeightsTexture,\n      triPositionBuffer,\n      triTexCoordBuffer,\n      colorTexture,\n      updateTimer\n    } = this.state;\n    /* eslint-disable no-unused-expressions */\n    weightsTransform && weightsTransform.delete();\n    weightsTexture && weightsTexture.delete();\n    maxWeightTransform && maxWeightTransform.delete();\n    maxWeightsTexture && maxWeightsTexture.delete();\n    triPositionBuffer && triPositionBuffer.delete();\n    triTexCoordBuffer && triTexCoordBuffer.delete();\n    colorTexture && colorTexture.delete();\n    updateTimer && clearTimeout(updateTimer);\n    /* eslint-enable no-unused-expressions */\n  }\n\n  // PRIVATE\n\n  // override Composite layer private method to create AttributeManager instance\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats\n    });\n  }\n\n  _getChangeFlags(opts) {\n    const changeFlags = {};\n    const {dimensions} = this.state;\n    changeFlags.dataChanged =\n      this.isAttributeChanged() || // if any attribute is changed\n      this.isAggregationDirty(opts, {\n        compareAll: true,\n        dimension: dimensions.data\n      });\n    changeFlags.viewportChanged = opts.changeFlags.viewportChanged;\n\n    const {zoom} = this.state;\n    if (!opts.context.viewport || opts.context.viewport.zoom !== zoom) {\n      changeFlags.viewportZoomChanged = true;\n    }\n\n    return changeFlags;\n  }\n\n  _createTextures() {\n    const {gl} = this.context;\n    const {textureSize, format, type} = this.state;\n\n    this.setState({\n      weightsTexture: new Texture2D(gl, {\n        width: textureSize,\n        height: textureSize,\n        format,\n        type,\n        ...TEXTURE_OPTIONS\n      }),\n      maxWeightsTexture: new Texture2D(gl, {format, type, ...TEXTURE_OPTIONS}) // 1 X 1 texture,\n    });\n  }\n\n  _setupAttributes() {\n    const attributeManager = this.getAttributeManager();\n    attributeManager.add({\n      positions: {size: 3, accessor: 'getPosition'},\n      weights: {size: 1, accessor: 'getWeight'}\n    });\n    this.setState({positionAttributeName: 'positions'});\n  }\n\n  _setupTextureParams() {\n    const {gl} = this.context;\n    const textureSize = Math.min(SIZE_2K, getParameters(gl, gl.MAX_TEXTURE_SIZE));\n    const floatTargetSupport = hasFeatures(gl, FEATURES.COLOR_ATTACHMENT_RGBA32F);\n    const {format, type} = getTextureParams({gl, floatTargetSupport});\n    const weightsScale = floatTargetSupport ? 1 : 1 / 255;\n    this.setState({textureSize, format, type, weightsScale});\n    if (!floatTargetSupport) {\n      log.warn(\n        `HeatmapLayer: ${\n          this.id\n        } rendering to float texture not supported, fallingback to low precession format`\n      )();\n    }\n  }\n\n  _createWeightsTransform(shaderOptions = {}) {\n    const {gl} = this.context;\n    let {weightsTransform} = this.state;\n    const {weightsTexture} = this.state;\n    if (weightsTransform) {\n      weightsTransform.delete();\n    }\n    const shaders = mergeShaders(\n      {\n        vs: weights_vs,\n        _fs: weights_fs,\n        modules: [project32]\n      },\n      shaderOptions\n    );\n\n    weightsTransform = new Transform(gl, {\n      id: `${this.id}-weights-transform`,\n      elementCount: 1,\n      _targetTexture: weightsTexture,\n      _targetTextureVarying: 'weightsTexture',\n      ...shaders\n    });\n    this.setState({weightsTransform});\n  }\n\n  _setupResources() {\n    const {gl} = this.context;\n    this._createTextures();\n    const {textureSize, weightsTexture, maxWeightsTexture} = this.state;\n    this._createWeightsTransform();\n    const maxWeightTransform = new Transform(gl, {\n      id: `${this.id}-max-weights-transform`,\n      _sourceTextures: {\n        inTexture: weightsTexture\n      },\n      _targetTexture: maxWeightsTexture,\n      _targetTextureVarying: 'outTexture',\n      vs: vs_max,\n      elementCount: textureSize * textureSize\n    });\n\n    this.setState({\n      weightsTexture,\n      maxWeightsTexture,\n      maxWeightTransform,\n      zoom: null,\n      triPositionBuffer: new Buffer(gl, {\n        byteLength: 48,\n        accessor: {size: 3}\n      }),\n      triTexCoordBuffer: new Buffer(gl, {\n        byteLength: 48,\n        accessor: {size: 2}\n      })\n    });\n  }\n\n  // overwrite super class method to update transform model\n  updateShaders(shaderOptions) {\n    // sahder params (modules, injects) changed, update model object\n    this._createWeightsTransform(shaderOptions);\n  }\n\n  _updateMaxWeightValue() {\n    const {maxWeightTransform} = this.state;\n    maxWeightTransform.run({\n      parameters: {\n        blend: true,\n        depthTest: false,\n        blendFunc: [GL.ONE, GL.ONE],\n        blendEquation: GL.MAX\n      }\n    });\n  }\n\n  // Computes world bounds area that needs to be processed for generate heatmap\n  _updateBounds(forceUpdate = false) {\n    const {viewport} = this.context;\n\n    // Unproject all 4 corners of the current screen coordinates into world coordinates (lng/lat)\n    // Takes care of viewport has non zero bearing/pitch (i.e axis not aligned with world coordiante system)\n    const viewportCorners = [\n      viewport.unproject([0, 0]),\n      viewport.unproject([viewport.width, 0]),\n      viewport.unproject([viewport.width, viewport.height]),\n      viewport.unproject([0, viewport.height])\n    ];\n\n    // #1: get world bounds for current viewport extends\n    const visibleWorldBounds = getBounds(viewportCorners); // TODO: Change to visible bounds\n\n    const newState = {visibleWorldBounds, viewportCorners};\n    let boundsChanged = false;\n\n    if (\n      forceUpdate ||\n      !this.state.worldBounds ||\n      !boundsContain(this.state.worldBounds, visibleWorldBounds)\n    ) {\n      // #2 : convert world bounds to common (Flat) bounds\n      // #3 : extend common bounds to match aspect ratio with viewport\n      const scaledCommonBounds = this._worldToCommonBounds(visibleWorldBounds);\n\n      // #4 :convert aligned common bounds to world bounds\n      const worldBounds = this._commonToWorldBounds(scaledCommonBounds);\n\n      // Clip webmercator projection limits\n      if (this.props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT) {\n        worldBounds[1] = Math.max(worldBounds[1], -85.051129);\n        worldBounds[3] = Math.min(worldBounds[3], 85.051129);\n        worldBounds[0] = Math.max(worldBounds[0], -360);\n        worldBounds[2] = Math.min(worldBounds[2], 360);\n      }\n\n      // #5: now convert world bounds to common using Layer's coordiante system and origin\n      const normalizedCommonBounds = this._worldToCommonBounds(worldBounds);\n\n      newState.worldBounds = worldBounds;\n      newState.normalizedCommonBounds = normalizedCommonBounds;\n\n      boundsChanged = true;\n    }\n    this.setState(newState);\n    return boundsChanged;\n  }\n\n  _updateTextureRenderingBounds() {\n    // Just render visible portion of the texture\n    const {\n      triPositionBuffer,\n      triTexCoordBuffer,\n      normalizedCommonBounds,\n      viewportCorners\n    } = this.state;\n\n    const {viewport} = this.context;\n\n    triPositionBuffer.subData(packVertices(viewportCorners, 3));\n\n    const textureBounds = viewportCorners.map(p =>\n      getTextureCoordinates(viewport.projectPosition(p), normalizedCommonBounds)\n    );\n    triTexCoordBuffer.subData(packVertices(textureBounds, 2));\n  }\n\n  _updateColorTexture(opts) {\n    const {colorRange} = opts.props;\n    let {colorTexture} = this.state;\n    const colors = colorRangeToFlatArray(colorRange, true);\n\n    if (colorTexture) {\n      colorTexture.setImageData({\n        data: colors,\n        width: colorRange.length\n      });\n    } else {\n      colorTexture = new Texture2D(this.context.gl, {\n        data: colors,\n        width: colorRange.length,\n        height: 1,\n        format: isWebGL2(this.context.gl) ? GL.RGBA32F : GL.RGBA,\n        type: GL.FLOAT,\n        ...TEXTURE_OPTIONS\n      });\n    }\n    this.setState({colorTexture});\n  }\n\n  _updateWeightmap() {\n    const {radiusPixels} = this.props;\n    const {weightsTransform, worldBounds, textureSize, weightsTexture, weightsScale} = this.state;\n\n    // #5: convert world bounds to common using Layer's coordiante system and origin\n    const commonBounds = this._worldToCommonBounds(worldBounds, {\n      useLayerCoordinateSystem: true\n    });\n\n    const uniforms = {\n      radiusPixels,\n      commonBounds,\n      textureWidth: textureSize,\n      weightsScale\n    };\n    // Attribute manager sets data array count as instaceCount on model\n    // we need to set that as elementCount on 'weightsTransform'\n    weightsTransform.update({\n      elementCount: this.getNumInstances()\n    });\n    weightsTransform.run({\n      uniforms,\n      parameters: {\n        blend: true,\n        depthTest: false,\n        blendFunc: [GL.ONE, GL.ONE],\n        blendEquation: GL.FUNC_ADD\n      },\n      clearRenderTarget: true,\n      attributes: this.getAttributes(),\n      moduleSettings: this.getModuleSettings()\n    });\n    this._updateMaxWeightValue();\n\n    // reset filtering parameters (TODO: remove once luma issue#1193 is fixed)\n    weightsTexture.setParameters({\n      [GL.TEXTURE_MAG_FILTER]: GL.LINEAR,\n      [GL.TEXTURE_MIN_FILTER]: GL.LINEAR\n    });\n\n    this.setState({lastUpdate: Date.now()});\n  }\n\n  _debouncedUpdateWeightmap(fromTimer = false) {\n    let {updateTimer} = this.state;\n    const timeSinceLastUpdate = Date.now() - this.state.lastUpdate;\n\n    if (fromTimer) {\n      updateTimer = null;\n    }\n\n    if (timeSinceLastUpdate >= ZOOM_DEBOUNCE) {\n      // update\n      this._updateBounds(true);\n      this._updateWeightmap();\n      this._updateTextureRenderingBounds();\n    } else if (!updateTimer) {\n      updateTimer = setTimeout(\n        this._debouncedUpdateWeightmap.bind(this, true),\n        ZOOM_DEBOUNCE - timeSinceLastUpdate\n      );\n    }\n\n    this.setState({updateTimer});\n  }\n\n  // input: worldBounds: [minLong, minLat, maxLong, maxLat]\n  // input: opts.useLayerCoordinateSystem : layers coordiante system is used\n  // optput: commonBounds: [minX, minY, maxX, maxY] scaled to fit the current texture\n  _worldToCommonBounds(worldBounds, opts = {}) {\n    const {useLayerCoordinateSystem = false} = opts;\n    const [minLong, minLat, maxLong, maxLat] = worldBounds;\n    const {viewport} = this.context;\n    const {textureSize} = this.state;\n\n    const size = (textureSize * RESOLUTION) / viewport.scale;\n\n    let bottomLeftCommon;\n    let topRightCommon;\n\n    // Y-axis is flipped between World and Common bounds\n    if (useLayerCoordinateSystem) {\n      bottomLeftCommon = this.projectPosition([minLong, minLat, 0]);\n      topRightCommon = this.projectPosition([maxLong, maxLat, 0]);\n    } else {\n      bottomLeftCommon = viewport.projectPosition([minLong, minLat, 0]);\n      topRightCommon = viewport.projectPosition([maxLong, maxLat, 0]);\n    }\n    // Ignore z component\n    let commonBounds = bottomLeftCommon.slice(0, 2).concat(topRightCommon.slice(0, 2));\n    commonBounds = scaleToAspectRatio(commonBounds, size, size);\n    return commonBounds;\n  }\n\n  // input commonBounds: [xMin, yMin, xMax, yMax]\n  // output worldBounds: [minLong, minLat, maxLong, maxLat]\n  _commonToWorldBounds(commonBounds) {\n    const [xMin, yMin, xMax, yMax] = commonBounds;\n    const {viewport} = this.context;\n    const bottomLeftWorld = viewport.unprojectPosition([xMin, yMin]);\n    const topRightWorld = viewport.unprojectPosition([xMax, yMax]);\n\n    return bottomLeftWorld.slice(0, 2).concat(topRightWorld.slice(0, 2));\n  }\n}\n\nHeatmapLayer.layerName = 'HeatmapLayer';\nHeatmapLayer.defaultProps = defaultProps;\n"],"file":"heatmap-layer.js"}