{"version":3,"sources":["../../../src/lib/parse-mvt.js"],"names":["VectorTile","Protobuf","transformCoordinates","transformToLocalCoordinates","parseMVT","input","options","byteLength","tile","loaderOptions","mvt","features","selectedLayers","Array","isArray","layers","Object","keys","forEach","layerName","vectorTileLayer","featureOptions","i","length","vectorTileFeature","feature","decodedFeature","getDecodedFeature","push","wgs84Coordinates","coordinates","hasTileIndex","tileIndex","x","y","z","Error","toGeoJSON","layerProperty","properties"],"mappings":";;;;;;AAAA,SAAQA,UAAR,QAAyB,qBAAzB;AACA,OAAOC,QAAP,MAAqB,KAArB;AACA,SAAQC,oBAAR,EAA8BC,2BAA9B,QAAgE,4BAAhE;AAQA,eAAe,SAASC,QAAT,CAAkBC,KAAlB,EAAyBC,OAAzB,EAAkC;AAC/C,MAAID,KAAK,CAACE,UAAN,KAAqB,CAAzB,EAA4B;AAC1B,WAAO,EAAP;AACD;;AAED,MAAMC,IAAI,GAAG,IAAIR,UAAJ,CAAe,IAAIC,QAAJ,CAAaI,KAAb,CAAf,CAAb;AACA,MAAMI,aAAa,GAAGH,OAAO,CAACI,GAA9B;AACA,MAAMC,QAAQ,GAAG,EAAjB;AAEA,MAAMC,cAAc,GAAGC,KAAK,CAACC,OAAN,CAAcL,aAAa,CAACM,MAA5B,IACnBN,aAAa,CAACM,MADK,GAEnBC,MAAM,CAACC,IAAP,CAAYT,IAAI,CAACO,MAAjB,CAFJ;AAIAH,EAAAA,cAAc,CAACM,OAAf,CAAuB,UAAAC,SAAS,EAAI;AAClC,QAAMC,eAAe,GAAGZ,IAAI,CAACO,MAAL,CAAYI,SAAZ,CAAxB;;AACA,QAAME,cAAc,mCAAOZ,aAAP;AAAsBU,MAAAA,SAAS,EAATA;AAAtB,MAApB;;AAEA,QAAI,CAACC,eAAL,EAAsB;AACpB;AACD;;AAED,SAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,eAAe,CAACG,MAApC,EAA4CD,CAAC,EAA7C,EAAiD;AAC/C,UAAME,iBAAiB,GAAGJ,eAAe,CAACK,OAAhB,CAAwBH,CAAxB,CAA1B;AAEA,UAAMI,cAAc,GAAGC,iBAAiB,CAACH,iBAAD,EAAoBH,cAApB,CAAxC;AACAV,MAAAA,QAAQ,CAACiB,IAAT,CAAcF,cAAd;AACD;AACF,GAdD;AAgBA,SAAOf,QAAP;AACD;;AAED,SAASgB,iBAAT,CAA2BF,OAA3B,EAAkD;AAAA,MAAdnB,OAAc,uEAAJ,EAAI;AAChD,MAAMuB,gBAAgB,GAAGvB,OAAO,CAACwB,WAAR,KAAwB,OAAjD;AACA,MAAMC,YAAY,GAChBzB,OAAO,CAAC0B,SAAR,IAAqB1B,OAAO,CAAC0B,SAAR,CAAkBC,CAAvC,IAA4C3B,OAAO,CAAC0B,SAAR,CAAkBE,CAA9D,IAAmE5B,OAAO,CAAC0B,SAAR,CAAkBG,CADvF;;AAGA,MAAIN,gBAAgB,IAAI,CAACE,YAAzB,EAAuC;AACrC,UAAM,IAAIK,KAAJ,CAAU,6EAAV,CAAN;AACD;;AAED,MAAMV,cAAc,GAClBG,gBAAgB,IAAIE,YAApB,GACIN,OAAO,CAACY,SAAR,CAAkB/B,OAAO,CAAC0B,SAAR,CAAkBC,CAApC,EAAuC3B,OAAO,CAAC0B,SAAR,CAAkBE,CAAzD,EAA4D5B,OAAO,CAAC0B,SAAR,CAAkBG,CAA9E,CADJ,GAEIjC,oBAAoB,CAACuB,OAAD,EAAUtB,2BAAV,CAH1B;;AAMA,MAAIG,OAAO,CAACgC,aAAZ,EAA2B;AACzBZ,IAAAA,cAAc,CAACa,UAAf,CAA0BjC,OAAO,CAACgC,aAAlC,IAAmDhC,OAAO,CAACa,SAA3D;AACD;;AAED,SAAOO,cAAP;AACD","sourcesContent":["import {VectorTile} from '@mapbox/vector-tile';\nimport Protobuf from 'pbf';\nimport {transformCoordinates, transformToLocalCoordinates} from './transform-to-local-range';\n\n/*\n  * Parse MVT arrayBuffer and return GeoJSON.\n  *\n  * @param {arrayBuffer} _ A MVT arrayBuffer\n  * @return {?Object} A GeoJSON geometry object\n  */\nexport default function parseMVT(input, options) {\n  if (input.byteLength === 0) {\n    return [];\n  }\n\n  const tile = new VectorTile(new Protobuf(input));\n  const loaderOptions = options.mvt;\n  const features = [];\n\n  const selectedLayers = Array.isArray(loaderOptions.layers)\n    ? loaderOptions.layers\n    : Object.keys(tile.layers);\n\n  selectedLayers.forEach(layerName => {\n    const vectorTileLayer = tile.layers[layerName];\n    const featureOptions = {...loaderOptions, layerName};\n\n    if (!vectorTileLayer) {\n      return;\n    }\n\n    for (let i = 0; i < vectorTileLayer.length; i++) {\n      const vectorTileFeature = vectorTileLayer.feature(i);\n\n      const decodedFeature = getDecodedFeature(vectorTileFeature, featureOptions);\n      features.push(decodedFeature);\n    }\n  });\n\n  return features;\n}\n\nfunction getDecodedFeature(feature, options = {}) {\n  const wgs84Coordinates = options.coordinates === 'wgs84';\n  const hasTileIndex =\n    options.tileIndex && options.tileIndex.x && options.tileIndex.y && options.tileIndex.z;\n\n  if (wgs84Coordinates && !hasTileIndex) {\n    throw new Error('MVT Loader: WGS84 coordinates need tileIndex property. Check documentation.');\n  }\n\n  const decodedFeature =\n    wgs84Coordinates && hasTileIndex\n      ? feature.toGeoJSON(options.tileIndex.x, options.tileIndex.y, options.tileIndex.z)\n      : transformCoordinates(feature, transformToLocalCoordinates);\n\n  // Add layer name to GeoJSON properties\n  if (options.layerProperty) {\n    decodedFeature.properties[options.layerProperty] = options.layerName;\n  }\n\n  return decodedFeature;\n}\n"],"file":"parse-mvt.js"}