{"version":3,"sources":["../../../../src/lib/loader-utils/get-data.js"],"names":["ERR_DATA","getUrlFromData","data","url","name","replace","getArrayBufferOrStringFromDataSync","loader","text","ArrayBuffer","arrayBuffer","binary","textDecoder","TextDecoder","decode","isView","buffer","byteLength","length","byteOffset","slice","Error","getArrayBufferOrStringFromData","isArrayBuffer","response","getAsyncIteratorFromData","body","Symbol","asyncIterator","getIteratorFromData","oneChunk","iterator"],"mappings":"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","sourcesContent":["/* global TextDecoder */\nimport {\n  isResponse,\n  isReadableStream,\n  isAsyncIterable,\n  isIterable,\n  isIterator,\n  isBlob,\n  isBuffer\n} from '../../javascript-utils/is-type';\nimport {makeIterator} from '../../iterator-utils/make-iterator/make-iterator';\nimport {concatenateChunksAsync} from '../../iterator-utils/async-iteration';\nimport fetchFileReadable from '../fetch/fetch-file.browser';\nimport {checkFetchResponseStatus} from './check-errors';\n\nconst ERR_DATA = 'Cannot convert supplied data type';\n\n// Extract a URL from `parse` arguments if possible\n// If a fetch Response object or File/Blob were passed in get URL from those objects\nexport function getUrlFromData(data, url) {\n  if (isResponse(data)) {\n    url = url || data.url;\n  } else if (isBlob(url)) {\n    // File or Blob\n    url = url.name;\n  }\n  // Strip any query string\n  return typeof url === 'string' ? url.replace(/\\?.*/, '') : url;\n}\n\n// eslint-disable-next-line complexity\nexport function getArrayBufferOrStringFromDataSync(data, loader) {\n  if (loader.text && typeof data === 'string') {\n    return data;\n  }\n\n  if (data instanceof ArrayBuffer) {\n    const arrayBuffer = data;\n    if (loader.text && !loader.binary) {\n      const textDecoder = new TextDecoder('utf8');\n      return textDecoder.decode(arrayBuffer);\n    }\n    return arrayBuffer;\n  }\n\n  // We may need to handle offsets\n  if (ArrayBuffer.isView(data) || isBuffer(data)) {\n    // TextDecoder is invoked on typed arrays and will handle offsets\n    if (loader.text && !loader.binary) {\n      const textDecoder = new TextDecoder('utf8');\n      return textDecoder.decode(data);\n    }\n\n    let arrayBuffer = data.buffer;\n\n    // Since we are returning the underlying arrayBuffer, we must create a new copy\n    // if this typed array / Buffer is a partial view into the ArryayBuffer\n    // TODO - this is a potentially unnecessary copy\n    const byteLength = data.byteLength || data.length;\n    if (data.byteOffset !== 0 || byteLength !== arrayBuffer.byteLength) {\n      // console.warn(`loaders.gl copying arraybuffer of length ${byteLength}`);\n      arrayBuffer = arrayBuffer.slice(data.byteOffset, data.byteOffset + byteLength);\n    }\n    return arrayBuffer;\n  }\n\n  throw new Error(ERR_DATA);\n}\n\n// Convert async iterator to a promise\nexport async function getArrayBufferOrStringFromData(data, loader) {\n  // Resolve any promise\n  data = await data;\n\n  const isArrayBuffer = data instanceof ArrayBuffer || ArrayBuffer.isView(data);\n  if (typeof data === 'string' || isArrayBuffer) {\n    return getArrayBufferOrStringFromDataSync(data, loader);\n  }\n\n  // Blobs and files are FileReader compatible\n  if (isBlob(data)) {\n    data = await fetchFileReadable(data);\n  }\n\n  if (isResponse(data)) {\n    const response = data;\n    await checkFetchResponseStatus(response);\n    return loader.binary ? await response.arrayBuffer() : await response.text();\n  }\n\n  if (isReadableStream(data)) {\n    data = makeIterator(data);\n  }\n\n  if (isIterable(data) || isAsyncIterable(data)) {\n    // Assume arrayBuffer iterator - attempt to concatenate\n    return concatenateChunksAsync(data);\n  }\n\n  throw new Error(ERR_DATA);\n}\n\nexport async function getAsyncIteratorFromData(data) {\n  if (isIterator(data)) {\n    return data;\n  }\n\n  if (isResponse(data)) {\n    // Note Since this function is not async, we currently can't load error message, just status\n    await checkFetchResponseStatus(data);\n    // TODO - bug in polyfill, body can be a Promise under Node.js\n    return makeIterator(data.body);\n  }\n\n  if (isBlob(data) || isReadableStream(data)) {\n    return makeIterator(data);\n  }\n\n  if (isAsyncIterable(data)) {\n    return data[Symbol.asyncIterator]();\n  }\n\n  return getIteratorFromData(data);\n}\n\nexport function getIteratorFromData(data) {\n  // generate an iterator that emits a single chunk\n  if (ArrayBuffer.isView(data)) {\n    return (function* oneChunk() {\n      yield data.buffer;\n    })();\n  }\n\n  if (data instanceof ArrayBuffer) {\n    return (function* oneChunk() {\n      yield data;\n    })();\n  }\n\n  if (isIterator(data)) {\n    return data;\n  }\n\n  if (isIterable(data)) {\n    return data[Symbol.iterator]();\n  }\n\n  throw new Error(ERR_DATA);\n}\n"],"file":"get-data.js"}